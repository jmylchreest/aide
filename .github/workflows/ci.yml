name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  typescript:
    name: TypeScript Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Build TypeScript
        run: npm run build

      - name: Run tests
        run: npx vitest run --reporter=verbose --exclude='tests/memory-capture.test.ts'

      - name: Lint
        run: npm run lint
        continue-on-error: true  # Don't fail on lint initially

  go:
    name: Go Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: aide
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: aide/go.mod
          cache-dependency-path: aide/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./pkg/...

      - name: Upload coverage
        uses: codecov/codecov-action@v5
        with:
          files: aide/coverage.out
          flags: go
        continue-on-error: true

  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: aide/go.mod
          cache-dependency-path: aide/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: latest
          working-directory: aide

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [typescript, go]
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: aide/go.mod
          cache-dependency-path: aide/go.sum

      - name: Install Node dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build
        continue-on-error: true  # May not have full build setup yet

      - name: Build aide
        run: |
          cd aide
          go build -ldflags "-s -w" -o ../bin/aide ./cmd/aide

      - name: Verify binary
        run: ./bin/aide --help

      - name: Upload aide binary
        uses: actions/upload-artifact@v6
        with:
          name: aide-linux-amd64
          path: bin/aide

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: aide/go.mod
          cache-dependency-path: aide/go.sum

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Build aide
        run: |
          cd aide
          go build -o ../bin/aide ./cmd/aide

      - name: Test hooks with aide
        run: |
          # Create test directories
          mkdir -p .aide/memory .aide/state .aide/skills

          # Test skill injector (handles skill triggers with fuzzy matching)
          echo '{"hook_event_name":"UserPromptSubmit","prompt":"test","cwd":"'$(pwd)'"}' | \
            node dist/hooks/skill-injector.js | \
            jq -e '.continue == true'

          # Test pre-tool enforcer
          echo '{"hook_event_name":"PreToolUse","tool_name":"Read","agent_name":"architect","cwd":"'$(pwd)'"}' | \
            node dist/hooks/pre-tool-enforcer.js | \
            jq -e '.continue == true'

          # Test aide CLI
          ./bin/aide memory add --category=learning "CI test memory"
          ./bin/aide memory list | grep -q "CI test"

          echo "All integration tests passed"
